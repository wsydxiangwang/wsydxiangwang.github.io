<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>缓存机制 | 不吃茶的v李白</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/images/photo.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="Live and Study.">
    <meta name="theme-color" content="#0084ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/images/photo">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.db326a3d.css" as="style"><link rel="preload" href="/assets/js/app.88e404aa.js" as="script"><link rel="preload" href="/assets/js/2.3ade598f.js" as="script"><link rel="preload" href="/assets/js/32.35f9930d.js" as="script"><link rel="prefetch" href="/assets/js/10.ad76ea56.js"><link rel="prefetch" href="/assets/js/100.8f621884.js"><link rel="prefetch" href="/assets/js/101.62282461.js"><link rel="prefetch" href="/assets/js/102.4a97d4a6.js"><link rel="prefetch" href="/assets/js/103.b8e33499.js"><link rel="prefetch" href="/assets/js/104.df304c75.js"><link rel="prefetch" href="/assets/js/105.14b588e9.js"><link rel="prefetch" href="/assets/js/106.1ccd2603.js"><link rel="prefetch" href="/assets/js/107.ea737dd3.js"><link rel="prefetch" href="/assets/js/108.d3bf397d.js"><link rel="prefetch" href="/assets/js/109.67dff983.js"><link rel="prefetch" href="/assets/js/11.d6b7633f.js"><link rel="prefetch" href="/assets/js/110.cee53b64.js"><link rel="prefetch" href="/assets/js/111.5502e712.js"><link rel="prefetch" href="/assets/js/112.35f0fa9c.js"><link rel="prefetch" href="/assets/js/113.dbedb8cf.js"><link rel="prefetch" href="/assets/js/114.093e8b6a.js"><link rel="prefetch" href="/assets/js/115.d8402521.js"><link rel="prefetch" href="/assets/js/116.ca290b69.js"><link rel="prefetch" href="/assets/js/117.b782dac9.js"><link rel="prefetch" href="/assets/js/118.4f527b52.js"><link rel="prefetch" href="/assets/js/119.e2925def.js"><link rel="prefetch" href="/assets/js/12.40a17f5c.js"><link rel="prefetch" href="/assets/js/120.b43fe9f2.js"><link rel="prefetch" href="/assets/js/121.e469ec14.js"><link rel="prefetch" href="/assets/js/122.67d1a23e.js"><link rel="prefetch" href="/assets/js/123.fb2ba8d5.js"><link rel="prefetch" href="/assets/js/124.f570ad57.js"><link rel="prefetch" href="/assets/js/125.05d45c46.js"><link rel="prefetch" href="/assets/js/126.0f794e79.js"><link rel="prefetch" href="/assets/js/127.738f6ba1.js"><link rel="prefetch" href="/assets/js/128.0a45f635.js"><link rel="prefetch" href="/assets/js/129.941db71e.js"><link rel="prefetch" href="/assets/js/13.956713c0.js"><link rel="prefetch" href="/assets/js/130.1ff8370f.js"><link rel="prefetch" href="/assets/js/131.edb825cc.js"><link rel="prefetch" href="/assets/js/132.37e3eac9.js"><link rel="prefetch" href="/assets/js/133.79f3742f.js"><link rel="prefetch" href="/assets/js/134.7e419ec3.js"><link rel="prefetch" href="/assets/js/135.8d1ca173.js"><link rel="prefetch" href="/assets/js/136.142440a5.js"><link rel="prefetch" href="/assets/js/137.32794e77.js"><link rel="prefetch" href="/assets/js/138.2e053317.js"><link rel="prefetch" href="/assets/js/139.56aac002.js"><link rel="prefetch" href="/assets/js/14.ccfea41e.js"><link rel="prefetch" href="/assets/js/140.3276427e.js"><link rel="prefetch" href="/assets/js/141.c336c781.js"><link rel="prefetch" href="/assets/js/142.73b77388.js"><link rel="prefetch" href="/assets/js/143.3e0bb007.js"><link rel="prefetch" href="/assets/js/144.178ffaf6.js"><link rel="prefetch" href="/assets/js/145.741b46d5.js"><link rel="prefetch" href="/assets/js/146.e0db1842.js"><link rel="prefetch" href="/assets/js/15.27bccea2.js"><link rel="prefetch" href="/assets/js/16.0b38d6b0.js"><link rel="prefetch" href="/assets/js/17.a9860779.js"><link rel="prefetch" href="/assets/js/18.5455624f.js"><link rel="prefetch" href="/assets/js/19.2d9d9103.js"><link rel="prefetch" href="/assets/js/20.26154616.js"><link rel="prefetch" href="/assets/js/21.f0c74013.js"><link rel="prefetch" href="/assets/js/22.c68fce0a.js"><link rel="prefetch" href="/assets/js/23.d3e8829b.js"><link rel="prefetch" href="/assets/js/24.12b9e5da.js"><link rel="prefetch" href="/assets/js/25.18fc80c2.js"><link rel="prefetch" href="/assets/js/26.6b012ea3.js"><link rel="prefetch" href="/assets/js/27.8fe4bf26.js"><link rel="prefetch" href="/assets/js/28.9817ff16.js"><link rel="prefetch" href="/assets/js/29.dd61f795.js"><link rel="prefetch" href="/assets/js/3.93110761.js"><link rel="prefetch" href="/assets/js/30.81d99e44.js"><link rel="prefetch" href="/assets/js/31.eb21e002.js"><link rel="prefetch" href="/assets/js/33.37ef31e8.js"><link rel="prefetch" href="/assets/js/34.11bb4c14.js"><link rel="prefetch" href="/assets/js/35.6b1bc1b1.js"><link rel="prefetch" href="/assets/js/36.35e94475.js"><link rel="prefetch" href="/assets/js/37.07732054.js"><link rel="prefetch" href="/assets/js/38.2e36013e.js"><link rel="prefetch" href="/assets/js/39.599a2c61.js"><link rel="prefetch" href="/assets/js/4.9c3db780.js"><link rel="prefetch" href="/assets/js/40.c90a3b31.js"><link rel="prefetch" href="/assets/js/41.1b0b5125.js"><link rel="prefetch" href="/assets/js/42.65f9a8be.js"><link rel="prefetch" href="/assets/js/43.2c303b69.js"><link rel="prefetch" href="/assets/js/44.d720c2c1.js"><link rel="prefetch" href="/assets/js/45.4c5172bd.js"><link rel="prefetch" href="/assets/js/46.e1de6c1c.js"><link rel="prefetch" href="/assets/js/47.80708058.js"><link rel="prefetch" href="/assets/js/48.578a4566.js"><link rel="prefetch" href="/assets/js/49.f02dc89e.js"><link rel="prefetch" href="/assets/js/5.0fc286d4.js"><link rel="prefetch" href="/assets/js/50.afc7f766.js"><link rel="prefetch" href="/assets/js/51.457e8354.js"><link rel="prefetch" href="/assets/js/52.f3384dd3.js"><link rel="prefetch" href="/assets/js/53.bd0de74a.js"><link rel="prefetch" href="/assets/js/54.d65a876c.js"><link rel="prefetch" href="/assets/js/55.3a7bfb38.js"><link rel="prefetch" href="/assets/js/56.52d0a0b0.js"><link rel="prefetch" href="/assets/js/57.2cd0b089.js"><link rel="prefetch" href="/assets/js/58.e1b9409a.js"><link rel="prefetch" href="/assets/js/59.361df5e6.js"><link rel="prefetch" href="/assets/js/6.e2789da8.js"><link rel="prefetch" href="/assets/js/60.bb48cc63.js"><link rel="prefetch" href="/assets/js/61.4accd75d.js"><link rel="prefetch" href="/assets/js/62.1bd7ab56.js"><link rel="prefetch" href="/assets/js/63.64a0c41f.js"><link rel="prefetch" href="/assets/js/64.6934f7f1.js"><link rel="prefetch" href="/assets/js/65.bcc9841d.js"><link rel="prefetch" href="/assets/js/66.925a2cc0.js"><link rel="prefetch" href="/assets/js/67.d047db96.js"><link rel="prefetch" href="/assets/js/68.66a6bc81.js"><link rel="prefetch" href="/assets/js/69.72fd061f.js"><link rel="prefetch" href="/assets/js/7.10e393d8.js"><link rel="prefetch" href="/assets/js/70.9a5ea1cd.js"><link rel="prefetch" href="/assets/js/71.092883d7.js"><link rel="prefetch" href="/assets/js/72.44b8d071.js"><link rel="prefetch" href="/assets/js/73.f49754fe.js"><link rel="prefetch" href="/assets/js/74.249811ee.js"><link rel="prefetch" href="/assets/js/75.928b3cc9.js"><link rel="prefetch" href="/assets/js/76.adb151de.js"><link rel="prefetch" href="/assets/js/77.5b45c13f.js"><link rel="prefetch" href="/assets/js/78.995d65e2.js"><link rel="prefetch" href="/assets/js/79.9666a5c1.js"><link rel="prefetch" href="/assets/js/8.41794894.js"><link rel="prefetch" href="/assets/js/80.99cf4849.js"><link rel="prefetch" href="/assets/js/81.92b9c181.js"><link rel="prefetch" href="/assets/js/82.7a7c552c.js"><link rel="prefetch" href="/assets/js/83.75642b40.js"><link rel="prefetch" href="/assets/js/84.b681752b.js"><link rel="prefetch" href="/assets/js/85.2ded5e4f.js"><link rel="prefetch" href="/assets/js/86.eaca5986.js"><link rel="prefetch" href="/assets/js/87.3c46df43.js"><link rel="prefetch" href="/assets/js/88.67bbabe3.js"><link rel="prefetch" href="/assets/js/89.9878270d.js"><link rel="prefetch" href="/assets/js/9.e634cc3d.js"><link rel="prefetch" href="/assets/js/90.ef688f64.js"><link rel="prefetch" href="/assets/js/91.2b28f089.js"><link rel="prefetch" href="/assets/js/92.a97ab7c8.js"><link rel="prefetch" href="/assets/js/93.50bdf9c5.js"><link rel="prefetch" href="/assets/js/94.87bb97b7.js"><link rel="prefetch" href="/assets/js/95.39aff75a.js"><link rel="prefetch" href="/assets/js/96.bf6db0f6.js"><link rel="prefetch" href="/assets/js/97.f7f5ab8e.js"><link rel="prefetch" href="/assets/js/98.e6d70f1e.js"><link rel="prefetch" href="/assets/js/99.e2dd657c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.db326a3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">不吃茶的v李白</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  进阶
</a></div><div class="nav-item"><a href="/after/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="https://raindays.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  心情小镇
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wsydxiangwang/Mood" target="_blank" rel="noopener noreferrer" class="nav-link external">
  全栈项目
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wsydxiangwang/Note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  进阶
</a></div><div class="nav-item"><a href="/after/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="https://raindays.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  心情小镇
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wsydxiangwang/Mood" target="_blank" rel="noopener noreferrer" class="nav-link external">
  全栈项目
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wsydxiangwang/Note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue 原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue 方法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DOM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数组</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>对象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>字符串</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>this 闭包 原型</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异步方法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>浏览器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/web/browser/1.html" class="sidebar-link">本地存储</a></li><li><a href="/web/browser/2.html" class="active sidebar-link">缓存机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/browser/2.html#强缓存" class="sidebar-link">强缓存</a></li><li class="sidebar-sub-header"><a href="/web/browser/2.html#协商缓存" class="sidebar-link">协商缓存</a></li><li class="sidebar-sub-header"><a href="/web/browser/2.html#缓存机制-2" class="sidebar-link">缓存机制</a></li><li class="sidebar-sub-header"><a href="/web/browser/2.html#缓存位置" class="sidebar-link">缓存位置</a></li><li class="sidebar-sub-header"><a href="/web/browser/2.html#缓存策略" class="sidebar-link">缓存策略</a></li><li class="sidebar-sub-header"><a href="/web/browser/2.html#总结-2" class="sidebar-link">总结</a></li></ul></li><li><a href="/web/browser/3.html" class="sidebar-link">运行机制</a></li><li><a href="/web/browser/4.html" class="sidebar-link">前端安全</a></li><li><a href="/web/browser/5.html" class="sidebar-link">浏览器输入URL后发生了什么</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>正则</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="缓存机制"><a href="#缓存机制" class="header-anchor">#</a> 缓存机制</h1> <p>缓存是性能优化中非常重要的一环，浏览器的缓存机制对开发也是非常重要的知识点。</p> <p>浏览器缓存，也称Http缓存，分为强缓存和协商缓存。优先级较高的是强缓存，在命中强缓存失败的情况下，才会走协商缓存。</p> <p>接下来以三个部分来把浏览器的缓存机制说清楚：</p> <ul><li>强缓存</li> <li>协商缓存</li> <li>缓存位置</li></ul> <h2 id="强缓存"><a href="#强缓存" class="header-anchor">#</a> 强缓存</h2> <p>浏览器中的缓存作用分为两种情况，一种是需要发送<code>HTTP</code>请求，一种是不需要发送。</p> <p>首先是向浏览器缓存发起检查，这个阶段不需要发送<code>HTTP</code>请求。</p> <h3 id="expires"><a href="#expires" class="header-anchor">#</a> Expires</h3> <p>Expires即过期时间，存在于服务端返回的响应头中，告诉浏览器在这个过期时间之前可以直接从缓存里面获取数据，无需再次请求。比如下面这样:</p> <div class="language-js extra-class"><pre class="language-js"><code>Expires<span class="token operator">:</span> Wed<span class="token punctuation">,</span> <span class="token number">22</span> Nov <span class="token number">2019</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">41</span><span class="token operator">:</span><span class="token number">00</span> <span class="token constant">GMT</span>
</code></pre></div><p>表示资源在<code>2019年11月22号8点41分</code>过期，过期了就得向服务端发请求。</p> <p>这个方式看上去没什么问题，合情合理，但其实潜藏了一个坑，那就是<strong>服务器的时间和浏览器的时间可能并不一致</strong>，那服务器返回的这个过期时间可能就是不准确的。因此这种方式很快在后来的HTTP1.1版本中被抛弃了。</p> <h3 id="cache-control"><a href="#cache-control" class="header-anchor">#</a> Cache-Control</h3> <p>在HTTP1.1 新增了 <code>Cache-Control</code> 字段来完成 <code>expires</code> 的任务。</p> <p>它和<code>Expires</code>本质的不同在于它并没有采用<strong>具体的过期时间点</strong>这个方式，而是采用过期时长来控制缓存，对应的字段是<code>max-age</code>。比如这个例子:</p> <div class="language-js extra-class"><pre class="language-js"><code>Cache<span class="token operator">-</span>Control<span class="token operator">:</span> max<span class="token operator">-</span>age<span class="token operator">=</span><span class="token number">3600</span>
</code></pre></div><p>代表这个响应返回后在 3600 秒，也就是一个小时之内可以直接使用缓存。</p> <p>Cache-Control可以在请求头或者响应头中设置，并且可以组合使用多种指令：</p> <p><img src="/assets/img/cache.d397f083.png" alt=""></p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p><code>Expires</code> 是http1.0的产物，<code>Cache-Control</code> 是http1.1的产物。</p> <p><code>Cache-Control</code> 相对于 <code>Expires</code> 更加准确，它的优先级也更高。</p> <p>两者同时存在的话，<strong>Cache-Control优先级高于Expires</strong>；在某些不支持HTTP1.1的环境下，Expires就会发挥用处。所以Expires其实是过时的产物，现阶段它的存在只是一种兼容性的写法。</p> <ul><li>缓存生效：返回 200 OK (from memory cache) (from disk cache)</li> <li>缓存失效：进入协商缓存</li></ul> <h2 id="协商缓存"><a href="#协商缓存" class="header-anchor">#</a> 协商缓存</h2> <p><strong>协商缓存依赖于服务端与浏览器之间的通信。</strong></p> <p>浏览器携带缓存标识向服务器发起请求，由服务器根据缓存标识决定是否使用缓存的过程，主要有以下两种情况：</p> <ul><li>协商缓存生效，返回304和Not Modified</li> <li>协商缓存失效，返回200和请求结果</li></ul> <p>协商缓存可以通过设置两种 HTTP Header 实现：Last-Modified 和 ETag 。</p> <h3 id="last-modified"><a href="#last-modified" class="header-anchor">#</a> Last-Modified</h3> <p>即最后修改时间。在浏览器第一次给服务器发送请求后，服务器会在响应头(Response Headers)中加上这个字段：</p> <div class="language-js extra-class"><pre class="language-js"><code>Last<span class="token operator">-</span>Modified<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">22</span> Jul <span class="token number">2016</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">00</span> <span class="token constant">GMT</span>
</code></pre></div><p>浏览器接收到后，如果再次请求，会在请求头中携带<code>If-Modified-Since</code>的字段，它的值正是上一次 response 返回给它的 <code>last-modified</code> 值：</p> <div class="language-js extra-class"><pre class="language-js"><code>If<span class="token operator">-</span>Modified<span class="token operator">-</span>Since<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">27</span> Oct <span class="token number">2017</span> <span class="token number">06</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">57</span> <span class="token constant">GMT</span>
</code></pre></div><p>服务器拿到请求头中的<code>If-Modified-Since</code>的字段后，会跟服务器中该资源的最后修改时间进行对比:</p> <ul><li>如果发生了变化，就会返回新的资源和200，跟常规的HTTP请求响应的流程一样。并在 Response Headers 中添加新的 <code>Last-Modified</code> 值；</li> <li>否则返回304，告诉浏览器直接从缓存读取。Response Headers 不会再添加 <code>Last-Modified</code> 字段。</li></ul> <h3 id="etag"><a href="#etag" class="header-anchor">#</a> ETag</h3> <p><strong>Etag 是服务器响应请求时，返回当前资源文件的一个唯一标识(由服务器生成)，只要资源有变化，Etag就会重新生成。</strong></p> <p>浏览器接收到<code>ETag</code>的值，会在下次请求时，将这个值作为<code>If-None-Match</code>这个字段的内容，并放到请求头中，然后发给服务器。</p> <p>服务器接收到<code>If-None-Match</code>后，会跟服务器上该资源的<code>ETag</code>进行比对:</p> <ul><li>如果两者不一样，说明要更新了。返回新的资源和200，跟常规的HTTP请求响应的流程一样。</li> <li>否则返回304，告诉浏览器直接用缓存。</li></ul> <h3 id="两者对比"><a href="#两者对比" class="header-anchor">#</a> 两者对比</h3> <ol><li>在精准度上，<code>ETag</code>优于<code>Last-Modified</code>。</li></ol> <p>由于<code>ETag</code>是按照内容给资源上标识，因此能准确感知资源的变化。而<code>Last-Modified</code>就不一样了，它在一些特殊的情况并不能准确感知资源变化，主要有两种情况:</p> <ul><li>编辑了资源文件，但是文件内容并没有更改，这样也会造成缓存失效。</li> <li><code>Last-Modified</code>能够感知的单位时间是秒，如果文件在 1 秒内改变了多次，那么这时候的<code>Last-Modified</code>并没有体现出修改了。</li></ul> <ol start="2"><li><p>在性能上，<code>Last-Modified</code>优于<code>ETag</code>，也很简单理解，<code>Last-Modified</code>仅仅只是记录一个时间点，而<code>Etag</code>需要根据文件的具体内容生成哈希值。</p></li> <li><p>在优先级上，服务器校验优先考虑<code>Etag</code></p></li></ol> <h2 id="缓存机制-2"><a href="#缓存机制-2" class="header-anchor">#</a> 缓存机制</h2> <p>强制缓存优先于协商缓存进行，若强制缓存<code>(Expires和Cache-Control)</code>生效则直接使用缓存，若不生效则进行协商缓存<code>(Last-Modified / If-Modified-Since和Etag / If-None-Match)</code>。</p> <p>协商缓存由服务器决定是否使用缓存，</p> <p>若协商缓存失效，那么代表该请求的缓存失效，返回200，重新返回资源和缓存标识，再存入浏览器缓存中；</p> <p>生效则返回304，继续使用缓存。</p> <h2 id="缓存位置"><a href="#缓存位置" class="header-anchor">#</a> 缓存位置</h2> <p>前面我们已经提到，当强缓存命中或者协商缓存中服务器返回304的时候，我们直接从缓存中获取资源。那这些资源究竟缓存在什么位置呢？</p> <p>浏览器中的缓存位置一共有四种，按优先级从高到低排列分别是：</p> <ul><li>Service Worker</li> <li>Memory Cache（内存缓存）</li> <li>Disk Cache（硬盘缓存）</li> <li>Push Cache（推送缓存）</li></ul> <h3 id="service-worker"><a href="#service-worker" class="header-anchor">#</a> Service Worker</h3> <p>和Web Worker类似，是独立的线程，我们可以在这个线程中缓存文件，在主线程需要的时候读取这里的文件，Service Worker使我们可以自由选择缓存哪些文件以及文件的匹配、读取规则，并且缓存是持续性的</p> <h3 id="memory-cache-和-disk-cache"><a href="#memory-cache-和-disk-cache" class="header-anchor">#</a> Memory Cache 和 Disk Cache</h3> <p>Memory Cache指的是内存缓存，从效率上讲它是最快的。但是从存活时间来讲又是最短的，当渲染进程结束后，内存缓存也就不存在了。</p> <p>Disk Cache就是存储在磁盘中的缓存，从存取效率上讲是比内存缓存慢的，但是他的优势在于存储容量和存储时长。稍微有些计算机基础的应该很好理解，就不展开了。</p> <p>好，现在问题来了，既然两者各有优劣，那浏览器如何决定将资源放进内存还是硬盘呢？主要策略如下：</p> <ul><li>比较大的JS、CSS文件会直接被丢进磁盘，反之丢进内存</li> <li>内存使用率比较高的时候，文件优先进入磁盘</li></ul> <h3 id="push-cache"><a href="#push-cache" class="header-anchor">#</a> Push Cache</h3> <p>即推送缓存，这是浏览器缓存的最后一道防线。是HTTP/2的内容，目前应用较少</p> <p>Push Cache 是指 HTTP2 在 server push 阶段存在的缓存。这块的知识比较新，应用也还处于萌芽阶段，应用范围有限不代表不重要——HTTP2 是趋势、是未来。在它还未被推而广之的此时此刻，我仍希望大家能对 Push Cache 的关键特性有所了解：</p> <ul><li>Push Cache 是缓存的最后一道防线。浏览器只有在 Memory Cache、HTTP Cache 和 Service Worker Cache 均未命中的情况下才会去询问 Push Cache。</li> <li>Push Cache 是一种存在于会话阶段的缓存，当 session 终止时，缓存也随之释放。</li> <li>不同的页面只要共享了同一个 HTTP2 连接，那么它们就可以共享同一个 Push Cache。</li></ul> <h2 id="缓存策略"><a href="#缓存策略" class="header-anchor">#</a> 缓存策略</h2> <h3 id="频繁变动的资源"><a href="#频繁变动的资源" class="header-anchor">#</a> 频繁变动的资源</h3> <div class="language-js extra-class"><pre class="language-js"><code>Cache<span class="token operator">-</span>Control<span class="token operator">:</span> no<span class="token operator">-</span>cache
</code></pre></div><p>对于频繁变动的资源，首先需要使用 <code>Cache-Control: no-cache</code> 使浏览器每次都请求服务器，然后配合 <code>ETag</code> 或者 <code>Last-Modified</code> 来验证资源是否有效。这样的做法虽然不能节省请求数量，但是能显著减少响应数据大小。</p> <h3 id="不常变化的资源"><a href="#不常变化的资源" class="header-anchor">#</a> 不常变化的资源</h3> <div class="language-js extra-class"><pre class="language-js"><code>Cache<span class="token operator">-</span>Control<span class="token operator">:</span> max<span class="token operator">-</span>age<span class="token operator">=</span><span class="token number">31536000</span>
</code></pre></div><p>通常在处理这类资源时，给它们的 <code>Cache-Control</code> 配置一个很大的 <code>max-age=31536000</code> (一年)，这样浏览器之后请求相同的 URL 会命中强制缓存。而为了解决更新的问题，就需要在文件名(或者路径)中添加 hash， 版本号等动态字符，之后更改动态字符，从而达到更改引用 URL 的目的，让之前的强制缓存失效 (其实并未立即失效，只是不再使用了而已)。</p> <p>在线提供的类库 (如 jquery-3.3.1.min.js, lodash.min.js 等) 均采用这个模式。</p> <h3 id="用户行为对浏览器缓存的影响"><a href="#用户行为对浏览器缓存的影响" class="header-anchor">#</a> 用户行为对浏览器缓存的影响</h3> <p>所谓用户行为对浏览器缓存的影响，指的就是用户在浏览器如何操作时，会触发怎样的缓存策略。主要有 3 种：</p> <ul><li>打开网页，地址栏输入地址： 查找 disk cache 中是否有匹配。如有则使用；如没有则发送网络请求。</li> <li>普通刷新 (F5)：因为 TAB 并没有关闭，因此 memory cache 是可用的，会被优先使用(如果匹配的话)。其次才是 disk cache。</li> <li>强制刷新 (Ctrl + F5)：浏览器不使用缓存，因此发送的请求头部均带有 <code>Cache-control: no-cache</code> (为了兼容，还带了 <code>Pragma: no-cache</code>)，服务器直接返回 200 和最新内容。</li></ul> <h2 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h2> <p>对浏览器的缓存机制来做个简要的总结:</p> <p>首先通过<code>Cache-Control</code>验证强缓存是否可用</p> <ul><li>向浏览器缓存发起请求，如果强缓存可用，直接使用</li> <li>否则进入协商缓存，即发送<code>HTTP</code>请求，服务器通过请求头中的<code>If-Modified-Since</code>或者<code>If-None-Match</code>这些条件请求字段检查资源是否更新
<ul><li>若资源更新，返回资源和200状态码</li> <li>否则，返回304，告诉浏览器直接从缓存获取资源，再从浏览器缓存获取资源</li></ul></li></ul> <br> <ul><li><a href="https://www.jianshu.com/p/54cc04190252?_blank" target="_blank" rel="noopener noreferrer">深入理解浏览器的缓存机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/fengshi123/blog/issues/7" target="_blank" rel="noopener noreferrer">深入理解HTTP缓存机制及原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/web/browser/1.html" class="prev">
        本地存储
      </a></span> <span class="next"><a href="/web/browser/3.html">
        运行机制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.88e404aa.js" defer></script><script src="/assets/js/2.3ade598f.js" defer></script><script src="/assets/js/32.35f9930d.js" defer></script>
  </body>
</html>
